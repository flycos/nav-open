<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Tools Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .test-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .test-card {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
    }
    .test-card.success {
      border-color: #4CAF50;
      background: #f8fff8;
    }
    .test-card.error {
      border-color: #f44336;
      background: #fff8f8;
    }
    .test-card.warning {
      border-color: #ff9800;
      background: #fffaf0;
    }
    h1, h2, h3 {
      color: #333;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #1976D2;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Open Source Tools Navigation - Local Test</h1>
  
  <div id="test-controls">
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="testDataFile()">Test Data File</button>
    <button onclick="testPageStructure()">Test Page Structure</button>
    <button onclick="testSearchFunction()">Test Search</button>
    <button onclick="testDailyUpdate()">Test Daily Update</button>
  </div>
  
  <div id="test-results" class="test-results">
    <!-- Test results will appear here -->
  </div>
  
  <h2>Tools Data Preview</h2>
  <div id="tools-preview"></div>
  
  <script>
    // 检查数据文件是否存在
    async function testDataFile() {
      clearResults();
      try {
        const response = await fetch('data/tools.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        addTestResult('Data File Test', 'success', 
          `✅ Data file loaded successfully<br>
           Total tools: ${data.tools.length}<br>
           Last updated: ${new Date(data.metadata.lastUpdated).toLocaleString()}<br>
           Categories: ${data.metadata.categories.join(', ')}`);
        
        // 显示部分工具
        showToolsPreview(data.tools.slice(0, 10));
      } catch (error) {
        addTestResult('Data File Test', 'error', 
          `❌ Failed to load data file: ${error.message}<br>
           Please run: <code>npm run build</code> first`);
      }
    }
    
    // 测试页面结构
    function testPageStructure() {
      clearResults();
      
      const tests = [
        { id: 'search-input', type: 'element', name: 'Search Input' },
        { id: 'category-filter', type: 'element', name: 'Category Filter' },
        { id: 'tools-grid', type: 'element', name: 'Tools Grid' },
        { id: 'tool-count', type: 'element', name: 'Tool Count' },
        { className: 'tool-card', type: 'elements', name: 'Tool Cards' }
      ];
      
      let passed = 0;
      let failed = 0;
      
      tests.forEach(test => {
        let element;
        if (test.id) {
          element = document.getElementById(test.id);
        } else if (test.className) {
          element = document.getElementsByClassName(test.className);
        }
        
        if (test.type === 'element' ? element : element && element.length > 0) {
          addTestResult(`${test.name} Check`, 'success', '✅ Found');
          passed++;
        } else {
          addTestResult(`${test.name} Check`, 'error', '❌ Not found');
          failed++;
        }
      });
      
      addTestResult('Page Structure Test', 
        failed === 0 ? 'success' : 'warning',
        `${passed} passed, ${failed} failed`);
    }
    
    // 测试搜索功能
    async function testSearchFunction() {
      clearResults();
      
      try {
        const response = await fetch('data/tools.json');
        if (!response.ok) throw new Error('No data file');
        
        const data = await response.json();
        const tools = data.tools;
        
        // 测试搜索
        const searchTerm = 'AI';
        const aiTools = tools.filter(tool => 
          tool.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          tool.category.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        addTestResult('Search Function Test', 'success', 
          `Found ${aiTools.length} tools containing "${searchTerm}"`);
        
        // 测试分类过滤
        const devTools = tools.filter(tool => tool.category === 'Development');
        addTestResult('Category Filter Test', 'success', 
          `Found ${devTools.length} Development tools`);
        
      } catch (error) {
        addTestResult('Search Function Test', 'error', 
          `Test failed: ${error.message}`);
      }
    }
    
    // 测试每日更新
    async function testDailyUpdate() {
      clearResults();
      
      try {
        const response = await fetch('data/tools.json');
        if (!response.ok) throw new Error('No data file');
        
        const data = await response.json();
        const initialCount = data.tools.length;
        
        addTestResult('Current Tools Count', 'success', 
          `Currently have ${initialCount} tools`);
        
        // 模拟添加新工具
        const newTools = [
          { name: 'Test Tool 1', url: 'https://github.com/test1', category: 'Test', rating: 5 },
          { name: 'Test Tool 2', url: 'https://github.com/test2', category: 'Test', rating: 5 },
          { name: 'Test Tool 3', url: 'https://github.com/test3', category: 'Test', rating: 5 }
        ];
        
        // 模拟移除评分最低的3个
        const sortedTools = [...data.tools].sort((a, b) => (a.rating || 3) - (b.rating || 3));
        const removedTools = sortedTools.slice(0, 3);
        const remainingTools = sortedTools.slice(3);
        const finalTools = [...remainingTools, ...newTools];
        
        addTestResult('Update Simulation', 'success', 
          `Removed: ${removedTools.length} lowest-rated tools<br>
           Added: ${newTools.length} new tools<br>
           New total: ${finalTools.length} tools`);
        
        // 测试工具数量一致性
        if (finalTools.length === data.tools.length) {
          addTestResult('Tool Count Check', 'success', 
            'Tool count maintained (5000 tools)');
        } else {
          addTestResult('Tool Count Check', 'warning', 
            `Tool count changed: ${data.tools.length} → ${finalTools.length}`);
        }
        
      } catch (error) {
        addTestResult('Daily Update Test', 'error', 
          `Test failed: ${error.message}`);
      }
    }
    
    // 运行所有测试
    function runAllTests() {
      clearResults();
      addTestResult('Starting Tests', 'success', 'Running all tests...');
      
      setTimeout(() => testDataFile(), 100);
      setTimeout(() => testPageStructure(), 200);
      setTimeout(() => testSearchFunction(), 300);
      setTimeout(() => testDailyUpdate(), 400);
    }
    
    // 显示工具预览
    function showToolsPreview(tools) {
      const container = document.getElementById('tools-preview');
      container.innerHTML = '<h3>First 10 Tools:</h3>';
      
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.innerHTML = `
        <thead>
          <tr>
            <th style="border:1px solid #ddd; padding:8px;">Name</th>
            <th style="border:1px solid #ddd; padding:8px;">Category</th>
            <th style="border:1px solid #ddd; padding:8px;">URL</th>
            <th style="border:1px solid #ddd; padding:8px;">Rating</th>
          </tr>
        </thead>
        <tbody>
          ${tools.map(tool => `
            <tr>
              <td style="border:1px solid #ddd; padding:8px;">${tool.name}</td>
              <td style="border:1px solid #ddd; padding:8px;">${tool.category}</td>
              <td style="border:1px solid #ddd; padding:8px;">
                <a href="${tool.url}" target="_blank">${tool.url.substring(0, 30)}...</a>
              </td>
              <td style="border:1px solid #ddd; padding:8px;">${'★'.repeat(tool.rating || 3)}</td>
            </tr>
          `).join('')}
        </tbody>
      `;
      
      container.appendChild(table);
    }
    
    // 添加测试结果
    function addTestResult(title, type, message) {
      const resultsDiv = document.getElementById('test-results');
      const card = document.createElement('div');
      card.className = `test-card ${type}`;
      card.innerHTML = `
        <h3>${title}</h3>
        <div>${message}</div>
      `;
      resultsDiv.appendChild(card);
    }
    
    // 清空测试结果
    function clearResults() {
      document.getElementById('test-results').innerHTML = '';
      document.getElementById('tools-preview').innerHTML = '';
    }
    
    // 页面加载时自动运行数据文件测试
    window.onload = testDataFile;
  </script>
</body>
</html>
